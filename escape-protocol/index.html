<!doctype html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">

<title>SPACE SHOOTER</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }

  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
    touch-action: none;
    position: fixed;
  }

  #canvas {
    display: block;
    position: fixed; /* Changed to fixed for visual viewport alignment */
    top: 0; left: 0;
    width: 100%; height: 100%;
    visibility: hidden;
    image-rendering: pixelated;
    touch-action: none; /* Extra safety */
  }

  /* LOADER & START OVERLAY */
  #loader {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: radial-gradient(circle, #0a0a2e 0%, #000000 100%);
    z-index: 100;
    cursor: pointer;
  }

  #logo {
    font-family: 'Press Start 2P', cursive;
    font-size: clamp(18px, 5vw, 36px);
    color: #00ffe7;
    text-shadow: 0 0 15px #00ffe7;
    margin-bottom: 40px;
    text-align: center;
  }

  #status {
    font-family: 'Press Start 2P', cursive;
    font-size: 9px;
    color: #888;
    margin-bottom: 20px;
  }

  #barBox {
    width: 60%;
    max-width: 280px;
    height: 8px;
    background: #222;
    border-radius: 4px;
    margin-bottom: 30px;
    overflow: hidden;
    border: 1px solid #333;
  }

  #bar {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, #00ffe7, #ff6b6b);
    transition: width 0.2s;
  }

  #tapHint {
    display: none;
    font-family: 'Press Start 2P', cursive;
    font-size: 11px;
    color: #fff;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

  /* ROTATE PROMPT */
  #rotatePrompt {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: #000;
    z-index: 999;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    font-family: 'Press Start 2P', cursive;
  }

  @media screen and (orientation: portrait) {
    #rotatePrompt { display: flex; }
  }
</style>
</head>

<body>

  <div id="rotatePrompt">
    <div style="font-size: 40px; margin-bottom: 20px;">ðŸ“±â†»</div>
    <div style="font-size: 10px;">ROTATE TO LANDSCAPE</div>
  </div>

  <div id="loader" onclick="startGame()">
    <div id="logo">SPACE SHOOTER</div>
    <div id="status">LOADING ASSETS...</div>
    <div id="barBox"><div id="bar"></div></div>
    <div id="tapHint">TAP TO START CHAMP</div>
  </div>

  <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>

  <script>
    const canvas = document.getElementById("canvas");
    const loader = document.getElementById("loader");
    const tapHint = document.getElementById("tapHint");
    let gameStarted = false;

    // Enhanced resize using visualViewport (fixes touch offset in fullscreen on Android Chrome)
    function resize() {
      let width = window.innerWidth;
      let height = window.innerHeight;
      let offsetLeft = 0;
      let offsetTop = 0;

      if (window.visualViewport) {
        width = visualViewport.width;
        height = visualViewport.height;
        offsetLeft = visualViewport.offsetLeft;
        offsetTop = visualViewport.offsetTop;
      }

      // CSS size and position
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
      canvas.style.left = offsetLeft + 'px';
      canvas.style.top = offsetTop + 'px';

      // Canvas drawing buffer resolution (CSS pixels â†’ matches touch coordinates)
      canvas.width = width;
      canvas.height = height;

      // Optional: Use devicePixelRatio for sharper rendering (uncomment if game looks blurry)
      // const dpr = window.devicePixelRatio || 1;
      // canvas.width = Math.round(width * dpr);
      // canvas.height = Math.round(height * dpr);
      // canvas.style.imageRendering = 'pixelated'; // already in CSS
    }

    // Listeners
    window.addEventListener('resize', resize);
    if (window.visualViewport) {
      visualViewport.addEventListener('resize', resize);
      visualViewport.addEventListener('scroll', resize);
    }

    // Prevent unwanted touch gestures that can cause offsets
    canvas.addEventListener('touchstart', e => {
      e.preventDefault();
    }, { passive: false });

    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
    }, { passive: false });

    // Initial resize (in case loader shows before start)
    resize();

    // --- FULLSCREEN & NAVIGATION ---
    function startGame() {
      if (tapHint.style.display !== "block") return;

      const el = document.documentElement;
      const rfs = el.requestFullscreen || el.webkitRequestFullScreen || el.mozRequestFullScreen || el.msRequestFullscreen;
      
      if (rfs) {
        rfs.call(el).then(() => {
          window.addEventListener('resize', detectBackNavigation);
          resize(); // Ensure correct size after entering fullscreen
        }).catch(err => {
          console.error("Fullscreen failed:", err);
        });
      }

      // Audio unlock for mobile
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (AudioContext) { new AudioContext().resume(); }

      loader.style.display = "none";
      canvas.style.visibility = "visible";
      gameStarted = true;
      resize();

      // Push state to handle back button
      history.pushState({playing: true}, "");
    }

    function detectBackNavigation() {
      const isFullscreen = document.fullscreenElement || document.webkitIsFullScreen || document.mozFullScreen || document.msFullscreenElement;
      
      if (gameStarted && !isFullscreen) {
        window.removeEventListener('resize', detectBackNavigation);
        window.location.href = "../index.html"; 
      }
    }

    window.onpopstate = function() {
      window.location.href = "../index.html";
    };

    // --- LOVE.JS ENGINE CONFIG ---
    var Module = {
      arguments: ["./game.love"],
      INITIAL_MEMORY: 73554432,
      canvas: canvas,
      setStatus: function(text) {
        const s = document.getElementById("status");
        if (s) s.textContent = text;
        if (!text) {
          document.getElementById("barBox").style.display = "none";
          if (s) s.style.display = "none";
          tapHint.style.display = "block";
        }
      },
      monitorRunDependencies: function(left) {
        const total = this.totalDependencies || 0;
        const percent = total ? ((total - left) / total) * 100 : 0;
        document.getElementById("bar").style.width = percent + "%";
      }
    };
  </script>
  
  <script src="game.js"></script>
  <script async src="love.js" onload="Love(Module)"></script>

</body>
</html>