<!doctype html>
<html lang="en-us">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="format-detection" content="telephone=no">

<title>ESCAPE PROTOCOL - GameHub</title>

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }

  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    background: #000;
    overflow: hidden;
    touch-action: none;
    position: fixed;
    top: 0; left: 0;
  }

  #canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    visibility: hidden;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }

  /* Loader & Start Overlay */
  #loader {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(180deg, #0b0f1a, #05070d);
    z-index: 1000;
    cursor: pointer;
  }

  #logo {
    font-family: 'Press Start 2P', cursive;
    font-size: clamp(0.8rem, 4vw, 1.4rem);
    color: #00ffe7;
    text-shadow: 0 0 10px #00ffe7;
    text-align: center;
    margin-bottom: 30px;
  }

  #barBox {
    width: 70%;
    max-width: 300px;
    height: 12px;
    background: #222;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #333;
  }

  #bar {
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, #00ffe7, #00b3ff);
    transition: width 0.2s;
  }

  #status {
    margin-top: 15px;
    font-family: 'Press Start 2P', cursive;
    font-size: 8px;
    color: #888;
  }

  #tapHint {
    display: none;
    margin-top: 20px;
    font-family: 'Press Start 2P', cursive;
    font-size: 10px;
    color: #fff;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

  /* Rotate Prompt */
  #rotatePrompt {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: #000;
    z-index: 2000;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    font-family: 'Press Start 2P', cursive;
    text-align: center;
  }

  @media screen and (orientation: portrait) {
    #rotatePrompt { display: flex; }
  }

  .fadeOut {
    animation: fade 0.5s forwards;
    pointer-events: none;
  }
  @keyframes fade { to { opacity: 0; visibility: hidden; } }
</style>
</head>

<body>

  <div id="rotatePrompt">
    <div style="font-size: 40px; margin-bottom: 20px;">ðŸ“±â†»</div>
    <div style="font-size: 10px;">ROTATE TO LANDSCAPE</div>
  </div>

  <div id="loader" onclick="startGame()">
    <div id="logo">ðŸš€ ESCAPE PROTOCOL<br><span style="font-size:0.6em;color:#ff9900">The AI Planet</span></div>
    <div id="barBox"><div id="bar"></div></div>
    <div id="status">LOADING...</div>
    <div id="tapHint">TAP TO START CHAMP</div>
  </div>

  <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>

  <script>
    const canvas = document.getElementById("canvas");
    const loader = document.getElementById("loader");
    const tapHint = document.getElementById("tapHint");
    const statusBar = document.getElementById("status");
    const barBox = document.getElementById("barBox");
    let gameStarted = false;

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);

    // --- FULLSCREEN & NAVIGATION LOGIC ---
    function startGame() {
      // Only allow start if loading is finished (tapHint is visible)
      if (tapHint.style.display !== "block") return;

      // Request Fullscreen
      const el = document.documentElement;
      const rfs = el.requestFullscreen || el.webkitRequestFullScreen || el.mozRequestFullScreen || el.msRequestFullscreen;
      
      if (rfs) {
        rfs.call(el).then(() => {
          // Listen for when user exits fullscreen via system gestures
          window.addEventListener('resize', detectBackNavigation);
        }).catch((err) => {
          console.log("Fullscreen blocked or failed");
        });
      }

      // Unlock Audio Context
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      if (AudioContext) {
        const ctx = new AudioContext();
        if (ctx.state === 'suspended') ctx.resume();
      }

      // UI Transition
      loader.classList.add("fadeOut");
      canvas.style.visibility = "visible";
      gameStarted = true;
      resize();

      // Push history state so the physical back button has something to pop
      history.pushState({playing: true}, "");
    }

    function detectBackNavigation() {
      const isFullscreen = document.fullscreenElement || document.webkitIsFullScreen || document.mozFullScreen || document.msFullscreenElement;
      
      // If the game was running and we are no longer fullscreen, user likely swiped 'back'
      if (gameStarted && !isFullscreen) {
        window.removeEventListener('resize', detectBackNavigation);
        window.location.href = "../index.html"; 
      }
    }

    // Handle physical back button on Android/Browsers
    window.onpopstate = function() {
      window.location.href = "../index.html";
    };

    // --- PREVENT BROWSER GESTURES ---
    window.addEventListener('touchstart', e => { if (e.target === canvas) e.preventDefault(); }, { passive: false });
    window.addEventListener('touchmove', e => { if (e.target === canvas) e.preventDefault(); }, { passive: false });

    // --- LOVE.JS ENGINE CONFIG ---
    var Module = {
      arguments: ["./game.love"],
      INITIAL_MEMORY: 67108864, // Keeping your 64MB setting
      canvas: canvas,
      setStatus: function(text) {
        if (statusBar) statusBar.textContent = text;
        if (!text) {
          // Loading finished
          if (barBox) barBox.style.display = "none";
          if (statusBar) statusBar.style.display = "none";
          tapHint.style.display = "block";
        }
      },
      monitorRunDependencies: function(left) {
        const total = this.totalDependencies || 0;
        const percent = total ? ((total - left) / total) * 100 : 0;
        const bar = document.getElementById("bar");
        if (bar) bar.style.width = percent + "%";
      }
    };

    window.onerror = function() { Module.setStatus("Error - See Console"); };
  </script>
  
  <script src="game.js"></script>
  <script async src="love.js" onload="Love(Module)"></script>

</body>
</html>